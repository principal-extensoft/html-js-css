<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Surveyor</title>
  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- FontAwesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <!-- Vis.js for dependency graph -->
  <script src="https://unpkg.com/vis-network/standalone/umd/vis-network.min.js"></script>
  <style>
    :root {
      --primary-color: #1e293b;
      --secondary-color: #334155;
      --accent-color: #3b82f6;
      --success-color: #10b981;
      --warning-color: #f59e0b;
      --danger-color: #ef4444;
      --info-color: #06b6d4;
      --light-bg: #f8fafc;
      --card-bg: #ffffff;
      --text-primary: #1e293b;
      --text-secondary: #64748b;
      --border-color: #e2e8f0;
      --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
      --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
      --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
    }
    
    body {
      padding-top: 60px;
      background: linear-gradient(135deg, var(--light-bg) 0%, #e2e8f0 100%);
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      font-size: 14px;
      color: var(--text-primary);
    }
    
    /* Navbar shadow */
    .navbar {
      box-shadow: var(--shadow-md);
      background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%) !important;
      backdrop-filter: blur(10px);
    }

    /* Sidebar styling */
    #sidebar {
      max-height: 80vh;
      overflow-y: auto;
    }

    .navbar,
    .card-header,
    .nav-tabs .nav-link.active,
    .btn-primary {
      background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%) !important;
      border-color: var(--primary-color);
      color: #fff !important;
    }
    
    .nav-tabs .nav-link {
      color: var(--text-secondary);
      font-weight: 500;
      border: 1px solid transparent;
      border-bottom: none;
      transition: all 0.2s ease;
    }
    
    .nav-tabs .nav-link:hover {
      color: var(--accent-color);
      border-color: var(--border-color);
    }
    
    .nav-tabs .nav-link.active {
      font-weight: 600;
      border-color: var(--border-color);
      background: var(--card-bg);
      color: var(--primary-color) !important;
    }

    .ml-7 {
      margin-left: 7rem;
    }

    .ml-2 {
      margin-left: 2rem;
    }

    #rawJsonTextarea {
      font-size: 0.7rem;
    }
    
    #sidebar .card {
      margin-bottom: 1rem;
    }
    
    #recordList li {
      cursor: pointer;
      padding: 12px 16px;
      border-bottom: 1px solid var(--border-color);
      transition: all 0.2s ease;
      border-radius: 6px;
      margin-bottom: 4px;
    }
    
    #recordList li.selected {
      background: linear-gradient(135deg, var(--accent-color) 0%, #2563eb 100%);
      color: white;
      box-shadow: var(--shadow-sm);
    }
    
    #recordList li:hover {
      background: linear-gradient(135deg, #f1f5f9 0%, #e2e8f0 100%);
      transform: translateY(-1px);
      box-shadow: var(--shadow-sm);
    }
    
    #mainContent.disabled {
      pointer-events: none;
      opacity: 0.5;
    }

    #rawJsonTextarea {
      width: 100%;
      height: 60vh;
      font-family: 'JetBrains Mono', 'Fira Code', Consolas, monospace;
      background: var(--card-bg);
      border: 1px solid var(--border-color);
    }
    
    /* Treeview styling */
    .treeview ul {
      list-style-type: none;
      padding-left: 20px;
    }
    
    .treeview li {
      position: relative;
      margin: 2px 0;
    }
    
    .tree-toggle {
      cursor: pointer;
      margin-right: 5px;
      color: var(--accent-color);
      transition: color 0.2s ease;
    }
    
    .tree-toggle:hover {
      color: var(--primary-color);
    }
    
    .tree-collapsed > ul {
      display: none;
    }

    .card {
      border: none;
      border-radius: 12px;
      box-shadow: var(--shadow-md);
      background: var(--card-bg);
      transition: box-shadow 0.2s ease;
    }
    
    .card:hover {
      box-shadow: var(--shadow-lg);
    }

    .card-header {
      background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
      color: #fff;
      font-weight: 600;
      border-radius: 12px 12px 0 0 !important;
      padding: 16px 20px;
    }

    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(15, 23, 42, 0.6);
      backdrop-filter: blur(8px);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1050;
    }

    .modal-content {
      background: var(--card-bg);
      padding: 24px;
      border-radius: 16px;
      max-width: 900px;
      width: 90%;
      position: relative;
      box-shadow: var(--shadow-lg);
    }

    .modal-content h4 {
      background: linear-gradient(135deg, var(--light-bg) 0%, #e2e8f0 100%);
      padding: 12px 20px;
      border-radius: 8px;
      color: var(--primary-color);
      font-weight: 600;
    }
    
    .close {
      position: absolute;
      top: 16px;
      right: 20px;
      background: none;
      border: none;
      font-size: 1.5rem;
      cursor: pointer;
      color: var(--text-secondary);
      transition: color 0.2s ease;
    }
    
    .close:hover {
      color: var(--danger-color);
    }

    .kvp-container {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    
    .kvp-container.config div:last-child {
      margin-bottom: 12px;
    }
    
    .kvp-item {
      display: flex;
      align-items: flex-start;
      padding: 8px 0;
      border-bottom: 1px solid var(--border-color);
    }
    
    .kvp-key {
      width: 7rem;
      text-align: right;
      flex-shrink: 0;
      color: var(--text-secondary);
      font-weight: 500;
    }
    
    .kvp-container.config .kvp-key { 
      width: 10rem;
    }
    
    .kvp-value {
      margin-left: 3rem;
      flex-grow: 1;
      font-weight: 600;
      color: var(--text-primary);
    }
    
    .kvp-list {
      margin-left: 3rem;
      padding-left: 0;
      list-style-type: none;
    }
    
    .kvp-list li {
      padding: 4px 0;
    }
    
    .kvp-list span {
      color: var(--text-secondary);
    }
    
    .kvp-list li strong {
      padding-left: 2rem;
      color: var(--text-primary);
    }
    
    button.binding-details {
      background: linear-gradient(135deg, var(--info-color) 0%, #0891b2 100%);
      border: none;
      border-radius: 6px;
      transition: all 0.2s ease;
    }
    
    button.binding-details:hover {
      background: linear-gradient(135deg, #0891b2 0%, var(--info-color) 100%);
      transform: translateY(-1px);
      box-shadow: var(--shadow-sm);
    }
    
    button.binding-details i {
      font-size: 0.6rem;
    }
    
    button.config-details {
      background: linear-gradient(135deg, var(--accent-color) 0%, #2563eb 100%);
      border: none;
      border-radius: 6px;
      transition: all 0.2s ease;
    }
    
    button.config-details:hover {
      background: linear-gradient(135deg, #2563eb 0%, var(--accent-color) 100%);
      transform: translateY(-1px);
      box-shadow: var(--shadow-sm);
    }
    
    button.config-details i {
      font-size: 0.6rem;
    }
    
    .protocol-http {
      margin-left: 2.75rem;
    }
    
    .protocol-https, .connections {
      margin-left: 1rem;
    }
    
    ul.no-marker {
      list-style-type: none;
    }
    
    span.auth-display {
      margin-right: 0.5rem;
    }
    
    span.auth-display span {
      margin: 0 0.25rem 0 0;
    }
    
    .auth-display i {
      font-size: 0.7rem;
      font-weight: 500;
    }
    
    .auth-display span.anonymous-auth-true i,
    .auth-display span.windows-auth-true {
      font-weight: 900;
    }

    .anonymous-auth-true,
    .windows-auth-true {
      color: var(--success-color);
    }
    
    .anonymous-auth-false,
    .windows-auth-false {
      color: var(--text-secondary);
    }
    
    /* Dependency Graph Styling */
    #dependencyGraph {
      background: linear-gradient(135deg, var(--card-bg) 0%, var(--light-bg) 100%);
      border-radius: 12px;
      border: 1px solid var(--border-color);
    }
    
    .graph-legend {
      position: absolute;
      top: 16px;
      right: 16px;
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
      padding: 16px;
      border-radius: 12px;
      font-size: 12px;
      box-shadow: var(--shadow-md);
      border: 1px solid var(--border-color);
    }
    
    .legend-item {
      display: flex;
      align-items: center;
      margin-bottom: 8px;
      font-weight: 500;
    }
    
    .legend-color {
      width: 14px;
      height: 14px;
      border-radius: 50%;
      margin-right: 10px;
      box-shadow: var(--shadow-sm);
    }
    
    /* Graph Toolbar */
    .graph-toolbar {
      position: absolute;
      left: 16px;
      top: 10%;
      width: 200px;
      height: 80%;
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
      border-radius: 16px;
      padding: 20px;
      box-shadow: var(--shadow-lg);
      border: 1px solid var(--border-color);
      z-index: 100;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    
    .graph-toolbar h6 {
      margin: 0 0 16px 0;
      font-weight: 600;
      color: var(--primary-color);
      border-bottom: 2px solid var(--border-color);
      padding-bottom: 8px;
      font-size: 14px;
    }
    
    .toolbar-section {
      margin-bottom: 20px;
    }
    
    .toolbar-section label {
      font-size: 11px;
      font-weight: 600;
      color: var(--text-secondary);
      margin-bottom: 8px;
      display: block;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    .zoom-display {
      text-align: center;
      font-size: 16px;
      font-weight: 700;
      color: var(--accent-color);
      margin: 8px 0;
      padding: 8px;
      background: var(--light-bg);
      border-radius: 8px;
    }
    
    .btn-toolbar {
      font-size: 11px;
      padding: 8px 12px;
      border-radius: 8px;
      font-weight: 500;
      transition: all 0.2s ease;
    }
    
    .btn-toolbar:hover {
      transform: translateY(-1px);
      box-shadow: var(--shadow-sm);
    }
  
  </style>
</head>
<body>
  <!-- Navbar/Header -->
  <nav class="navbar navbar-expand-lg navbar-dark bg-primary fixed-top">
    <div class="container-fluid">
      <a class="navbar-brand" href="#">Surveyor</a>
    </div>
  </nav>

  <!-- Main container -->
  <div class="container-fluid mt-3">
    <div class="row">
      <!-- Left Sidebar -->
      <div id="sidebar" class="col-md-3 p-3">
        <div class="card">
          <div class="card-header">
            Actions
          </div>
          <div class="card-body">
            <button id="uploadBtn" class="btn btn-light me-2"><i class="fa fa-upload"></i> Upload</button>
            <button id="downloadBtn" class="btn btn-light" disabled><i class="fa fa-download"></i> Download</button>
            <input type="file" id="fileInput" accept=".json" style="display: none;">
          </div>
        </div>
        <div class="card">
          <div class="card-header">
            Records
          </div>
          <div class="card-body" style="max-height: 400px; overflow-y: auto;">
            <ul id="recordList" class="list-unstyled mb-0"></ul>
          </div>
        </div>
      </div>
      <!-- Main Content Area -->
      <div class="col-md-9 p-3">
        <div class="card">
          <div class="card-body">
            <ul class="nav nav-tabs" id="tabMenu" role="tablist">
              <!-- First tab: Tabular view -->
              <li class="nav-item" role="presentation">
                <button class="nav-link active" id="tabular-tab-btn" data-bs-toggle="tab" data-bs-target="#tabularTab" type="button" role="tab">Tabular</button>
              </li>
              <!-- Second tab: Treeview -->
              <li class="nav-item" role="presentation">
                <button class="nav-link" id="treeview-tab-btn" data-bs-toggle="tab" data-bs-target="#treeviewTab" type="button" role="tab">Treeview</button>
              </li>
              <!-- Third tab: Raw JSON -->
              <li class="nav-item" role="presentation">
                <button class="nav-link" id="rawjson-tab-btn" data-bs-toggle="tab" data-bs-target="#rawjsonTab" type="button" role="tab">Raw JSON</button>
              </li>
              <!-- Fourth tab: Dependency Graph -->
              <li class="nav-item" role="presentation">
                <button class="nav-link" id="dependency-tab-btn" data-bs-toggle="tab" data-bs-target="#dependencyTab" type="button" role="tab">Dependencies</button>
              </li>
            </ul>
            <div class="tab-content mt-3">
              <!-- Tab 1: Tabular view -->
              <div class="tab-pane fade show active" id="tabularTab" role="tabpanel">
                <div class="mb-3">
                  <label for="serverSelect" class="form-label">Select Server:</label>
                  <select id="serverSelect" class="form-select"></select>
                </div>
                <div class="mb-4">
                  <div class="card">
                    <div class="card-header">Sites</div>
                    <div class="card-body p-0">
                      <table class="table table-bordered mb-0" id="sitesTable">
                        <thead class="table-light">
                          <tr>
                            <th>Name</th>
                            <th>ID</th>
                            <th>State</th>
                            <th>Physical Path</th>
                            <th>Bindings</th>
                            <th>AppPool</th>
                          </tr>
                        </thead>
                        <tbody></tbody>
                      </table>
                    </div>
                  </div>
                  <div class="card mb-3">                    
                    <div class="card-header">AppPools</div>
                    <div class="card-body p-0">
                      <table class="table table-bordered mb-0" id="appPoolsTable">
                        <thead class="table-light">
                          <tr>
                            <th>Name</th>
                            <th>Identity</th>
                            <th>CLR Version</th>
                            <th>32-bit Enabled</th>
                            <th>State</th>
                          </tr>
                        </thead>
                        <tbody></tbody>
                      </table>
                    </div>
                  </div>
                </div>
              </div>
              <!-- Tab 2: Treeview -->
              <div class="tab-pane fade" id="treeviewTab" role="tabpanel">
                <div class="mb-2">
                  <button id="toggleTreeBtn" class="btn btn-secondary mb-2">
                    <i class="fa fa-plus-square"></i>
                  </button>
                </div>
                <div id="treeview" class="treeview"></div>               
              </div>
              <!-- Tab 3: Raw JSON -->
              <div class="tab-pane fade" id="rawjsonTab" role="tabpanel">
                <button id="copyBtn" class="btn btn-secondary mb-2"><i class="fa fa-copy"></i> Copy</button>
                <textarea id="rawJsonTextarea" class="form-control" readonly></textarea>
              </div>
              <!-- Tab 4: Dependency Graph -->
              <div class="tab-pane fade" id="dependencyTab" role="tabpanel">
                <div class="mb-3">
                  <label for="dependencyServerSelect" class="form-label">Select Server:</label>
                  <select id="dependencyServerSelect" class="form-select"></select>
                </div>
                <div class="mb-2">
                  <button id="resetGraphBtn" class="btn btn-secondary me-2"><i class="fa fa-refresh"></i> Reset View</button>
                  <button id="fitGraphBtn" class="btn btn-secondary"><i class="fa fa-expand"></i> Fit to Screen</button>
                </div>
                <!-- Graph Container with separate toolbar -->
                <div style="position: relative;">
                  <!-- Floating Graph Toolbar -->
                  <div class="graph-toolbar" id="graphToolbar">
                    <h6><i class="fa fa-cogs"></i> Graph Controls</h6>
                    
                    <div class="toolbar-section">
                      <label>Zoom Level</label>
                      <div class="zoom-display" id="zoomDisplay">100%</div>
                      <button class="btn btn-sm btn-outline-primary btn-toolbar w-100 mb-1" id="zoomInBtn"><i class="fa fa-plus"></i> Zoom In</button>
                      <button class="btn btn-sm btn-outline-primary btn-toolbar w-100 mb-1" id="zoomOutBtn"><i class="fa fa-minus"></i> Zoom Out</button>
                      <button class="btn btn-sm btn-outline-secondary btn-toolbar w-100" id="resetZoomBtn"><i class="fa fa-search"></i> Reset Zoom</button>
                    </div>
                    
                    <div class="toolbar-section">
                      <label>Layout</label>
                      <button class="btn btn-sm btn-outline-info btn-toolbar w-100 mb-1" id="toggleLayoutBtn"><i class="fa fa-rotate"></i> Flip Layout</button>
                      <button class="btn btn-sm btn-outline-info btn-toolbar w-100" id="stabilizeBtn"><i class="fa fa-refresh"></i> Stabilize</button>
                    </div>
                    
                    <div class="toolbar-section">
                      <label>Physics</label>
                      <button class="btn btn-sm btn-outline-warning btn-toolbar w-100" id="togglePhysicsBtn"><i class="fa fa-play"></i> Enable Physics</button>
                    </div>
                  </div>
                  <div id="dependencyGraph" style="width: 100%; height: 70vh; border: 1px solid #ccc; background: #fafafa; border-radius: 0.5rem;"></div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div id="certModal" class="modal-overlay" style="display:none;">
    <div class="modal-content">
      <button id="certModalClose" class="close">&times;</button>
      <h4>Certificate Details</h4>
      <div id="certDetails"></div>
    </div>
  </div>

  <div id="configModal" class="modal-overlay" style="display:none;">
    <div class="modal-content">
      <button id="configModalClose" class="close">&times;</button>
      <h4>DB Connections</h4>
      <div id="connectionDetails"></div>
      <h4>Endpoints</h4>
      <div id="endpointDetails"></div>
    </div>
  </div>

  <!-- Custom Script -->
  <script>
    // IndexedDB Setup
    const dbName = "SurveyorDB";
    const storeName = "records";
    let db;
    let selectedRecordId = null;
    
    function openDB() {
      return new Promise((resolve, reject) => {
        const request = indexedDB.open(dbName, 1);
        request.onerror = event => {
          console.error("IndexedDB error:", event);
          reject(event);
        };
        request.onsuccess = event => {
          db = event.target.result;
          resolve(db);
        };
        request.onupgradeneeded = event => {
          db = event.target.result;
          if (!db.objectStoreNames.contains(storeName)) {
            db.createObjectStore(storeName, { keyPath: "id" });
          }
        };
      });
    }

    function addRecord(record) {
      return new Promise((resolve, reject) => {
        const transaction = db.transaction([storeName], "readwrite");
        const store = transaction.objectStore(storeName);
        const request = store.add(record);
        request.onsuccess = () => resolve();
        request.onerror = e => reject(e);
      });
    }

    function getAllRecords() {
      return new Promise((resolve, reject) => {
        const transaction = db.transaction([storeName], "readonly");
        const store = transaction.objectStore(storeName);
        const request = store.getAll();
        request.onsuccess = () => resolve(request.result);
        request.onerror = e => reject(e);
      });
    }

    function deleteRecord(id) {
      return new Promise((resolve, reject) => {
        const transaction = db.transaction([storeName], "readwrite");
        const store = transaction.objectStore(storeName);
        const request = store.delete(id);
        request.onsuccess = () => resolve();
        request.onerror = e => reject(e);
      });
    }

    // Utility Functions
    function generateGUID() {
      // Generate a GUID and return first 6 characters
      const guid = 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
          const r = Math.random() * 16 | 0, v = c === 'x' ? r : (r & 0x3 | 0x8);
          return v.toString(16);
      });
      return guid.substring(0, 6);
    }

    function extractAtFromFilename(filename) {
      // Assume filename format: {date}.Get-IISInventory...
      const parts = filename.split(".Get-IISInventory");
      return parts[0]; // date part
    }

    function extractServersFromData(data) {
      // data is an array of server objects with "ServerName" field.
      const servers = data.map(item => item.ServerName).filter(Boolean);
      return [...new Set(servers)].join(", ");
    }

    let allExpanded = false;

    function setAllTreeNodes(expand){
      const toggles = document.querySelectorAll('.tree-toggle');
      toggles.forEach(function(toggle){
        const li = toggle.parentElement;
        if(expand){
          li.classList.remove("tree-collapsed");
          toggle.innerHTML = '<i class="fa fa-minus-square"></i>';
        } else {
          li.classList.add("tree-collapsed");
          toggle.innerHTML = '<i class="fa fa-plus-square"></i>';
        }        
      });
    }

    document.getElementById("toggleTreeBtn").onclick = function(){
      allExpanded = !allExpanded;
      setAllTreeNodes(allExpanded);
      this.innerHTML = allExpanded
        ? '<i class="fa fa-minus-square"></i> Collapse All'
        : '<i class="fa fa-plus-square"></i> Expand All';
    };

    // Treeview generation (recursive)
    function createTreeView(obj) {
      const ul = document.createElement("ul");
      for (const key in obj) {
        if (obj.hasOwnProperty(key)) {
          const li = document.createElement("li");
          const value = obj[key];
          if (typeof value === "object" && value !== null) {
            // Create expand/collapse control
            const toggle = document.createElement("span");
            toggle.className = "tree-toggle me-1";
            toggle.innerHTML = '<i class="fa fa-plus-square"></i>';
            toggle.onclick = function() {
              if (li.classList.contains("tree-collapsed")) {
                li.classList.remove("tree-collapsed");
                toggle.innerHTML = '<i class="fa fa-minus-square"></i>';
              } else {
                li.classList.add("tree-collapsed");
                toggle.innerHTML = '<i class="fa fa-plus-square"></i>';
              }
            };
            li.appendChild(toggle);
            li.appendChild(document.createTextNode(key + ":"));
            li.appendChild(createTreeView(value));
          } else {
            li.textContent = key + ": " + value;
          }
          ul.appendChild(li);
        }
      }
      return ul;
    }

    // Dependency Graph Functions
    let dependencyNetwork = null;

    function extractDependencyData(data, serverFilter = null) {
      const nodes = [];
      const edges = [];
      const nodeIds = new Set();

      // Helper function to add node if not exists
      function addNode(id, label, type, group, level = 0, title = '') {
        if (!nodeIds.has(id)) {
          nodes.push({
            id: id,
            label: label,
            group: group,
            level: level,
            title: title,
            type: type
          });
          nodeIds.add(id);
        }
      }

      // Helper function to add edge
      function addEdge(from, to, label = '', color = '#848484') {
        edges.push({
          from: from,
          to: to,
          label: label,
          color: { color: color },
          arrows: 'to'
        });
      }

      // Helper function to extract database info from connection string
      function extractDatabaseInfo(connectionString) {
        const serverMatch = connectionString.match(/(?:Server|Data Source)=([^;]+)/i);
        const dbMatch = connectionString.match(/(?:Database|Initial Catalog)=([^;]+)/i);
        
        return {
          server: serverMatch ? serverMatch[1].trim() : 'Unknown Server',
          database: dbMatch ? dbMatch[1].trim() : 'Unknown Database'
        };
      }

      // Filter data by server if specified
      const filteredData = serverFilter && serverFilter !== 'All' 
        ? data.filter(serverData => serverData.ServerName === serverFilter)
        : data;

      // Process each server
      filteredData.forEach(serverData => {
        const serverId = `server_${serverData.ServerName}`;
        
        // Add server node
        addNode(
          serverId, 
          serverData.ServerName, 
          'server',
          'servers', 
          1,
          `Server: ${serverData.ServerName}\\nIP: ${serverData.IPs.map(ip => ip.IP).join(', ')}`
        );

        // Process each site
        if (serverData.Sites) {
          serverData.Sites.forEach(site => {
            const siteId = `site_${serverData.ServerName}_${site.Name}`;
            
            // Add web application node
            addNode(
              siteId,
              site.Name,
              'webapp',
              'webapps',
              2,
              `Web App: ${site.Name}\\nState: ${site.State}\\nApp Pool: ${site.AppPool}\\nPath: ${site.PhysicalPath}`
            );

            // Connect server to web app
            addEdge(serverId, siteId, 'hosts', '#2e5e8b');

            // Process database connections
            if (site.Connections && site.Connections.length > 0) {
              site.Connections.forEach(conn => {
                const dbInfo = extractDatabaseInfo(conn.Connection);
                const dbServerId = `dbserver_${dbInfo.server}`;
                const dbId = `db_${dbInfo.server}_${dbInfo.database}`;

                // Add database server node
                addNode(
                  dbServerId,
                  dbInfo.server,
                  'dbserver',
                  'dbservers',
                  3,
                  `Database Server: ${dbInfo.server}`
                );

                // Add database node
                addNode(
                  dbId,
                  dbInfo.database,
                  'database',
                  'databases',
                  4,
                  `Database: ${dbInfo.database}\\nConnection: ${conn.Name}`
                );

                // Connect web app to database server
                addEdge(siteId, dbServerId, conn.Name, '#dc3545');
                
                // Connect database server to database
                addEdge(dbServerId, dbId, 'contains', '#6c757d');
              });
            }

            // Process API endpoints
            if (site.Endpoints && site.Endpoints.length > 0) {
              site.Endpoints.forEach(endpoint => {
                const apiId = `api_${endpoint.Key}_${endpoint.Value.replace(/[^a-zA-Z0-9]/g, '_')}`;
                
                // Add API node
                addNode(
                  apiId,
                  endpoint.Key,
                  'api',
                  'apis',
                  3,
                  `API: ${endpoint.Key}\\nEndpoint: ${endpoint.Value}`
                );

                // Connect web app to API
                addEdge(siteId, apiId, 'calls', '#198754');
              });
            }

            // Process applications within sites
            if (site.Applications && site.Applications.length > 0) {
              site.Applications.forEach(app => {
                const appId = `app_${serverData.ServerName}_${site.Name}_${app.Path.replace(/[^a-zA-Z0-9]/g, '_')}`;
                
                // Add application node
                addNode(
                  appId,
                  app.Path,
                  'webapp',
                  'webapps',
                  2,
                  `Application: ${app.Path}\\nPhysical Path: ${app.PhysicalPath}\\nApp Pool: ${app.ApplicationPool}`
                );

                // Connect site to application
                addEdge(siteId, appId, 'contains', '#fd7e14');

                // Process application database connections
                if (app.Connections && app.Connections.length > 0) {
                  app.Connections.forEach(conn => {
                    const dbInfo = extractDatabaseInfo(conn.Connection);
                    const dbServerId = `dbserver_${dbInfo.server}`;
                    const dbId = `db_${dbInfo.server}_${dbInfo.database}`;

                    addNode(dbServerId, dbInfo.server, 'dbserver', 'dbservers', 3, `Database Server: ${dbInfo.server}`);
                    addNode(dbId, dbInfo.database, 'database', 'databases', 4, `Database: ${dbInfo.database}\\nConnection: ${conn.Name}`);

                    addEdge(appId, dbServerId, conn.Name, '#dc3545');
                    addEdge(dbServerId, dbId, 'contains', '#6c757d');
                  });
                }

                // Process application API endpoints
                if (app.Endpoints && app.Endpoints.length > 0) {
                  app.Endpoints.forEach(endpoint => {
                    const apiId = `api_${endpoint.Key}_${endpoint.Value.replace(/[^a-zA-Z0-9]/g, '_')}`;
                    
                    addNode(apiId, endpoint.Key, 'api', 'apis', 3, `API: ${endpoint.Key}\\nEndpoint: ${endpoint.Value}`);
                    addEdge(appId, apiId, 'calls', '#198754');
                  });
                }
              });
            }
          });
        }
      });

      return { nodes, edges };
    }

    function populateDependencyServerSelect(record) {
      const serverSelect = document.getElementById('dependencyServerSelect');
      serverSelect.innerHTML = '';
      
      if (!record || !record.Data || record.Data.length === 0) {
        serverSelect.innerHTML = '<option>No servers found</option>';
        return;
      }
      
      // Add "All" option as first option
      const allOption = document.createElement('option');
      allOption.value = 'All';
      allOption.textContent = 'All Servers';
      serverSelect.appendChild(allOption);
      
      // Get unique server names
      const servers = [...new Set(record.Data.map(s => s.ServerName).filter(Boolean))];
      
      // Add individual server options
      servers.forEach(serverName => {
        const option = document.createElement('option');
        option.value = serverName;
        option.textContent = serverName;
        serverSelect.appendChild(option);
      });
      
      // Set up change event handler
      serverSelect.onchange = function() {
        createDependencyGraph(record, this.value);
      };
    }

    function createDependencyGraph(record, serverFilter = 'All') {
      const container = document.getElementById('dependencyGraph');
      
      if (!record || !record.Data) {
        container.innerHTML = '<div class="text-center mt-5"><h5>No data available for dependency graph</h5></div>';
        return;
      }

      // Clear any existing content
      container.innerHTML = '';

      const { nodes, edges } = extractDependencyData(record.Data, serverFilter);

      // Define node groups with modern professional colors
      const groups = {
        servers: {
          color: { 
            background: 'linear-gradient(135deg, #1e293b 0%, #334155 100%)', 
            border: '#0f172a',
            highlight: { background: '#334155', border: '#1e293b' }
          },
          shape: 'box',
          font: { color: 'white', size: 14, face: 'Inter', weight: '600' },
          size: 28,
          shadow: { enabled: true, color: 'rgba(0,0,0,0.2)', size: 5 }
        },
        webapps: {
          color: { 
            background: 'linear-gradient(135deg, #10b981 0%, #059669 100%)', 
            border: '#047857',
            highlight: { background: '#059669', border: '#047857' }
          },
          shape: 'ellipse',
          font: { color: 'white', size: 12, face: 'Inter', weight: '500' },
          size: 22,
          shadow: { enabled: true, color: 'rgba(0,0,0,0.15)', size: 4 }
        },
        dbservers: {
          color: { 
            background: 'linear-gradient(135deg, #3b82f6 0%, #2563eb 100%)', 
            border: '#1d4ed8',
            highlight: { background: '#2563eb', border: '#1d4ed8' }
          },
          shape: 'database',
          font: { color: 'white', size: 12, face: 'Inter', weight: '500' },
          size: 22,
          shadow: { enabled: true, color: 'rgba(0,0,0,0.15)', size: 4 }
        },
        databases: {
          color: { 
            background: 'linear-gradient(135deg, #f59e0b 0%, #d97706 100%)', 
            border: '#b45309',
            highlight: { background: '#d97706', border: '#b45309' }
          },
          shape: 'box',
          font: { color: 'white', size: 10, face: 'Inter', weight: '500' },
          size: 18,
          shadow: { enabled: true, color: 'rgba(0,0,0,0.1)', size: 3 }
        },
        apis: {
          color: { 
            background: 'linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%)', 
            border: '#6d28d9',
            highlight: { background: '#7c3aed', border: '#6d28d9' }
          },
          shape: 'diamond',
          font: { color: 'white', size: 10, face: 'Inter', weight: '500' },
          size: 18,
          shadow: { enabled: true, color: 'rgba(0,0,0,0.1)', size: 3 }
        }
      };

      // Network options
      const options = {
        groups: groups,
        layout: {
          hierarchical: {
            direction: 'UD',
            sortMethod: 'directed',
            levelSeparation: 150,
            nodeSpacing: 200,
            treeSpacing: 300,
            blockShifting: true,
            edgeMinimization: true,
            parentCentralization: true
          }
        },
        physics: {
          enabled: false
        },
        interaction: {
          hover: true,
          tooltipDelay: 300,
          zoomView: true,
          dragView: true
        },
        edges: {
          smooth: {
            type: 'cubicBezier',
            forceDirection: 'vertical',
            roundness: 0.4
          },
          font: { size: 10, face: 'Arial' }
        }
      };

      // Create network
      const data = { nodes: nodes, edges: edges };
      dependencyNetwork = new vis.Network(container, data, options);
      
      // Store current options globally for toolbar controls
      window.currentGraphOptions = options;
      window.currentGraphData = data;
      
      // Update zoom display
      updateZoomDisplay();
      
      // Add zoom change listener
      dependencyNetwork.on('zoom', function() {
        updateZoomDisplay();
      });

      // Add legend with updated colors
      const legend = `
        <div class="graph-legend">
          <div class="legend-item"><div class="legend-color" style="background: linear-gradient(135deg, #1e293b 0%, #334155 100%);"></div>Servers</div>
          <div class="legend-item"><div class="legend-color" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%);"></div>Web Apps</div>
          <div class="legend-item"><div class="legend-color" style="background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);"></div>DB Servers</div>
          <div class="legend-item"><div class="legend-color" style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);"></div>Databases</div>
          <div class="legend-item"><div class="legend-color" style="background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);"></div>APIs</div>
        </div>
      `;
      
      container.style.position = 'relative';
      container.insertAdjacentHTML('beforeend', legend);
      
      // Ensure toolbar is visible
      const toolbar = document.getElementById('graphToolbar');
      if (toolbar) {
        toolbar.style.display = 'flex';
      }
    }

    // Tabular view functions
    function updateTabularView(record) {
      // record.Data is an array of server objects.
      var serverSelect = document.getElementById("serverSelect");
      serverSelect.innerHTML = "";
      if (!record.Data || record.Data.length === 0) {
        serverSelect.innerHTML = "<option>No servers found</option>";
        return;
      }
      // Build a mapping of unique servers
      var servers = {};
      record.Data.forEach(function(s) {
        if (s.ServerName) {
          servers[s.ServerName] = s;
        }
      });
      // Populate select options
      for (var key in servers) {
        var option = document.createElement("option");
        option.value = key;
        option.textContent = key;
        serverSelect.appendChild(option);
      }
      // When the selection changes, update tables.
      serverSelect.onchange = function() {
        updateServerTables(serverSelect.value, servers);
      };
      // Also update tables for the first option.
      updateServerTables(serverSelect.value, servers);
    }

    function updateServerTables(serverName, servers) {
      var serverObj = servers[serverName];
      var appPoolsTableBody = document.querySelector("#appPoolsTable tbody");
      var sitesTableBody = document.querySelector("#sitesTable tbody");
      appPoolsTableBody.innerHTML = "";
      sitesTableBody.innerHTML = "";
      if (!serverObj) return;
      // Populate AppPools table
      if (serverObj.AppPools && Array.isArray(serverObj.AppPools)) {
        serverObj.AppPools.forEach(function(pool) {
          var row = document.createElement("tr");
          row.innerHTML = "<td>" + pool.Name + "</td>" +
                          "<td>" + (pool.Identity || "") + "</td>" +
                          "<td>" + (pool.CLRVersion || "") + "</td>" +
                          "<td>" + (pool.Enable32Bit ? "Yes" : "No") + "</td>" +
                          "<td>" + (pool.State || "") + "</td>";
          appPoolsTableBody.appendChild(row);
        });
      }
      // Populate Sites table
      if (serverObj.Sites && Array.isArray(serverObj.Sites)) {
        serverObj.Sites.forEach(function(site) {
          var bindings = "";
          if (site.Bindings && Array.isArray(site.Bindings)) {
            bindings = site.Bindings.map(function(b) {
              var text = '';
              var bindingClass = 'protocol-http';
              if(b.CertificateInfo){
                bindingClass = 'protocol-https';
                text += ' <button class="btn btn-sm btn-info binding-details" data-cert=\'' + JSON.stringify(b.CertificateInfo) + '\'><i class="fas fa-magnifying-glass"></i></button>';
              }
              text += "<span class='" + bindingClass + "'>" + `${b.Protocol}: ${b.BindingInformation}<span>`;
              return text;
            }).join("<br>");
          }
          var row = document.createElement("tr");
          var sitedisplay = generateSiteDisplay(site);
          var physicalpathdisplay = generatePhysicalPath(site);
          row.innerHTML = "<td>" + site.State + "</td>" +
                          sitedisplay + 
                          "<td>" + bindings + "</td>" +
                          "<td>" + physicalpathdisplay + "</td>" +
                          "<td>" + (site.AppPool || "") + "</td>";
          sitesTableBody.appendChild(row);
        });
      }
    }

    function sanitizeConnections(connections){
      for(const key in connections){
        if(connections.hasOwnProperty(key) && connections[key].Connection){
          connections[key].Connection = connections[key].Connection.replace(/'/g,'|');
        }
      }
    }

    function desanitizeConnections(connections){
      for(const key in connections){
        if(connections.hasOwnProperty(key) && connections[key].Connection){
          connections[key].Connection = connections[key].Connection.replace(/\|/g,"'");
        }
      }
    }

    function generateAuthenticationDisplay(authentication){
      let el = "<span class='auth-display'>";
      el += `<span class="anonymous-auth-${authentication.AnonymousAuthentication}" title="Allow Anonymous = ${authentication.AnonymousAuthentication}"><i class="fas fa-circle-question"></i></span>"`;
      el += `<span class="windows-auth-${authentication.WindowsAuthentication}" title="Windows Authentication = ${authentication.WindowsAuthentication}"><i class="fa fa-user"></i></span>`;
      el += "</span>";
      return el;
    }

    function generateSiteDisplay(site){
      if(site.Applications.length > 0){
        let el = "<td>" + generateAuthenticationDisplay(site.Authentication) + site.Name + "<ul class='no-marker'>";
          site.Applications.forEach(a =>{
            el += `<li><span>${generateAuthenticationDisplay(a.Authentication)}</span></li>`;
          });
          el += "</ul></td>";
          return el;
      } else {
        return "<td><div>" + generateAuthenticationDisplay(site.Authentication) + site.Name + "</div></td>";
      }
    }

    function generatePhysicalPath(site){
      var el = '';
      if(site.Applications.length > 0){
        el += "<span class='connections'>" + site.PhysicalPath + "<span>";
        el += "<ul class='no-marker'>";
        site.Applications.forEach(a =>{
          el += '<li>';
            let cl = 'ml-2';
            if(a.Connections && a.Connections.length > 0 || a.Endpoints && a.Endpoints.length > 0){
              el += '<button class="btn btn-sm btn-info config-details" title="' + a.Settings + '" data-cn=\'' + JSON.stringify(a.Connections) + '\' data-url=\''+ JSON.stringify(a.Endpoints) + '\'><i class="fas fa-list"></i></button>';
              el += `<span>${a.Path}</span></li>`;
            } else {
              el += `<span class='ml-2'>${a.Path}</span></li>`;
            }
        });
      } else {
        if(site.Connections && Array.isArray(site.Connections) && site.Connections.length > 0 || (site.Endpoints && Array.isArray(site.Endpoints) && site.Endpoints.length > 0)){
          var tooltip = (site.Settings && site.Settings === 'appsettings.json') ? 'appsettings.json' : 'web.config';
          sanitizeConnections(site.Connections);
          el += '<button class="btn btn-sm btn-info config-details" title="' + tooltip + '" data-cn=\'' + JSON.stringify(site.Connections) + '\' data-url=\'' + JSON.stringify(site.Endpoints) + '\'><i class="fas fa-list"></i></button>';
        }
        el += "<span class='connections'>" + site.PhysicalPath + "</span>";
      }
      return el;
    }

    // UI Functions
    function refreshRecordList() {
      getAllRecords().then(records => {
        const recordList = document.getElementById("recordList");
        recordList.innerHTML = "";
        records.sort((a, b) => a.At.localeCompare(b.At));
        records.forEach(record => {
          const li = document.createElement("li");
          li.classList.add("d-flex", "justify-content-between", "align-items-center");
          li.setAttribute("data-id", record.id);
          li.innerHTML = `<span>${record.At}</span>
                          <button class="btn btn-sm btn-danger delete-btn"><i class="fa fa-trash"></i></button>`;
          li.onclick = function(e) {
            if (e.target.closest(".delete-btn")) return; // ignore click on delete
            // Mark as selected
            document.querySelectorAll("#recordList li").forEach(item => item.classList.remove("selected"));
            li.classList.add("selected");
            selectedRecordId = record.id;
            document.getElementById("downloadBtn").disabled = false;
            displayRecord(record);
          };
          li.querySelector(".delete-btn").onclick = function(e) {
            e.stopPropagation();
            deleteRecord(record.id).then(() => {
              if (record.id === selectedRecordId) {
                selectedRecordId = null;
                document.getElementById("downloadBtn").disabled = true;
                document.getElementById("treeview").innerHTML = "";
                document.getElementById("rawJsonTextarea").value = "";
                document.getElementById("serverSelect").innerHTML = "";
                document.querySelector("#appPoolsTable tbody").innerHTML = "";
                document.querySelector("#sitesTable tbody").innerHTML = "";
              }
              refreshRecordList();
            });
          };
          recordList.appendChild(li);
        });
      });
    }

    function displayRecord(record) {
      // Display in Treeview tab
      const treeviewDiv = document.getElementById("treeview");
      treeviewDiv.innerHTML = "";
      const tree = createTreeView(record.Data);
      treeviewDiv.appendChild(tree);
      // Display in Raw JSON tab
      const rawJsonTextarea = document.getElementById("rawJsonTextarea");
      rawJsonTextarea.value = JSON.stringify(record.Data, null, 2);
      // Update Tabular view (select & tables)
      updateTabularView(record);
      // Populate Dependency Server Select and Create Dependency Graph
      populateDependencyServerSelect(record);
      createDependencyGraph(record);
    }

    // Event Handlers
    document.getElementById("uploadBtn").onclick = function() {
      document.getElementById("fileInput").click();
    };

    document.getElementById("fileInput").onchange = function(e) {
      const file = e.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = function(evt) {
        try {
          const jsonData = JSON.parse(evt.target.result);
          // Build record
          const record = {
            id: generateGUID(),
            At: extractAtFromFilename(file.name),
            Servers: extractServersFromData(jsonData),
            Data: jsonData,
            fileName: file.name
          };
          addRecord(record).then(() => {
            refreshRecordList();
          });
        } catch (err) {
          alert("Error parsing JSON file: " + err);
        }
      };
      reader.readAsText(file);
    };

    document.getElementById("downloadBtn").onclick = function() {
      if (!selectedRecordId) return;
      // Retrieve the selected record
      const transaction = db.transaction([storeName], "readonly");
      const store = transaction.objectStore(storeName);
      const request = store.get(selectedRecordId);
      request.onsuccess = function() {
        const record = request.result;
        const dataStr = JSON.stringify(record.Data, null, 2);
        const blob = new Blob([dataStr], { type: "application/json" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = record.fileName;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
      };
    };

    document.getElementById("copyBtn").onclick = function() {
      const textarea = document.getElementById("rawJsonTextarea");
      textarea.select();
      document.execCommand("copy");
      alert("Copied to clipboard!");
    };

    // Dependency Graph Event Handlers
    let physicsEnabled = false;
    let currentLayout = 'UD'; // UD = Up-Down, LR = Left-Right
    
    function updateZoomDisplay() {
      if (dependencyNetwork) {
        const scale = dependencyNetwork.getScale();
        const percentage = Math.round(scale * 100);
        document.getElementById('zoomDisplay').textContent = percentage + '%';
      }
    }
    
    document.getElementById("resetGraphBtn").onclick = function() {
      if (dependencyNetwork) {
        dependencyNetwork.setOptions({ physics: { enabled: true } });
        physicsEnabled = true;
        document.getElementById('togglePhysicsBtn').innerHTML = '<i class="fa fa-pause"></i> Disable Physics';
        setTimeout(() => {
          dependencyNetwork.setOptions({ physics: { enabled: false } });
          physicsEnabled = false;
          document.getElementById('togglePhysicsBtn').innerHTML = '<i class="fa fa-play"></i> Enable Physics';
        }, 3000);
      }
    };

    document.getElementById("fitGraphBtn").onclick = function() {
      if (dependencyNetwork) {
        dependencyNetwork.fit();
        setTimeout(updateZoomDisplay, 100);
      }
    };
    
    // New toolbar event handlers
    document.getElementById("zoomInBtn").onclick = function() {
      if (dependencyNetwork) {
        const scale = dependencyNetwork.getScale();
        dependencyNetwork.moveTo({ scale: scale * 1.2 });
        setTimeout(updateZoomDisplay, 100);
      }
    };
    
    document.getElementById("zoomOutBtn").onclick = function() {
      if (dependencyNetwork) {
        const scale = dependencyNetwork.getScale();
        dependencyNetwork.moveTo({ scale: scale * 0.8 });
        setTimeout(updateZoomDisplay, 100);
      }
    };
    
    document.getElementById("resetZoomBtn").onclick = function() {
      if (dependencyNetwork) {
        dependencyNetwork.moveTo({ scale: 1.0 });
        setTimeout(updateZoomDisplay, 100);
      }
    };
    
    document.getElementById("toggleLayoutBtn").onclick = function() {
      if (dependencyNetwork && window.currentGraphOptions) {
        currentLayout = currentLayout === 'UD' ? 'LR' : 'UD';
        const newOptions = { ...window.currentGraphOptions };
        newOptions.layout.hierarchical.direction = currentLayout;
        newOptions.edges.smooth.forceDirection = currentLayout === 'UD' ? 'vertical' : 'horizontal';
        
        dependencyNetwork.setOptions(newOptions);
        window.currentGraphOptions = newOptions;
        
        this.innerHTML = currentLayout === 'UD' 
          ? '<i class="fa fa-rotate"></i> Flip Layout' 
          : '<i class="fa fa-rotate"></i> Flip Layout';
      }
    };
    
    document.getElementById("stabilizeBtn").onclick = function() {
      if (dependencyNetwork) {
        dependencyNetwork.stabilize();
      }
    };
    
    document.getElementById("togglePhysicsBtn").onclick = function() {
      if (dependencyNetwork) {
        physicsEnabled = !physicsEnabled;
        dependencyNetwork.setOptions({ physics: { enabled: physicsEnabled } });
        this.innerHTML = physicsEnabled 
          ? '<i class="fa fa-pause"></i> Disable Physics' 
          : '<i class="fa fa-play"></i> Enable Physics';
      }
    };

    document.addEventListener("click",function(e){
      if(e.target.closest(".config-details")){
        e.preventDefault();
        var attrData = e.target.closest(".config-details").getAttribute("data-cn");
        var urlData = e.target.closest(".config-details").getAttribute("data-url");
        if(attrData){
          var cnData = JSON.parse(attrData);
          if(cnData && Array.isArray(cnData)){
            desanitizeConnections(cnData);
            let html = "<div class='kvp-container config'>";
              cnData.forEach(cn =>{
                html += `<div class='kvp-item'><div class='kvp-key'>${cn.Name}:</div><span class='kvp-value'>${cn.Connection}</span></div>`;
              });
              html += '</div>';
              document.getElementById("connectionDetails").innerHTML = html;
              document.getElementById("configModal").style.display = "flex";
          }          
        }
        if(urlData){
          var endpointData = JSON.parse(urlData);
          if(endpointData && Array.isArray(endpointData)){
            let html = "<div class='kvp-container config'>";
              endpointData.forEach(url =>{
                html += `<div class='kvp-item'><div class='kvp-key'>${url.Key}:</div><span class='kvp-value'>${url.Value}</span></div>`;
              });
              html += "</div>";
              document.getElementById("endpointDetails").innerHTML = html;
              document.getElementById("configModal").style.display = "flex";              
            }
        }
      }
      if(e.target.closest('.binding-details')){
        e.preventDefault();
        var certData = e.target.closest(".binding-details").getAttribute("data-cert");
        if(certData){
          var certInfo = JSON.parse(certData);
          var ulHtml = "<ul class='kvp-list'>" + (certInfo.SAN || '')
            .split(/\r?\n/)
            .map(item => item.trim())
            .filter(item => item !== "")
            .sort((a,b) => a.localeCompare(b))
            .map(item =>{
              let [key,value] = item.split('=');
              key = key ? key.trim() : '';
              value = value ? value.trim() : '';
              return `<li><span>${key}</span>: <strong>${value}</strong></li>`;
            })
            .join('') + '</ul>';

            var html = "<div class='kvp-container'>" +
            "<div class='kvp-item'><div class='kvp-key'>Subject:</div><span class='kvp-value'>" + certInfo.Subject + "</span></div>" +
            "<div class='kvp-item'><div class='kvp-key'>Issuer:</div><span class='kvp-value'>" + certInfo.Issuer + "</span></div>" +
            "<div class='kvp-item'><div class='kvp-key'>Not Before:</div><span class='kvp-value'>" + certInfo.NotBefore + "</span></div>" +
            "<div class='kvp-item'><div class='kvp-key'>Not After:</div><span class='kvp-value'>" + certInfo.NotAfter + "</span></div>" +
            "<div class='kvp-item'><div class='kvp-key'>Thumbprint:</div><span class='kvp-value'>" + certInfo.Thumbprint + "</span></div>" +
            "<div class='kvp-item'><div class='kvp-key'>Friendly Name:</div><span class='kvp-value'>" + certInfo.FriendlyName + "</span></div>" +
            "<div class='kvp-item'><div class='kvp-key'>Serial Number:</div><span class='kvp-value'>" + certInfo.SerialNumber + "</span></div>" +
            "<div class='kvp-item'><div class='kvp-key'>SubjectAltNames:</div>" + ulHtml + "</div></div>";
            document.getElementById("certDetails").innerHTML = html;
            document.getElementById("certModal").style.display = "flex";
        }
      }
    });

    document.getElementById("certModalClose").onclick = function(){
      document.getElementById("certModal").style.display = "none";
    };

    document.getElementById("certModal").onclick = function(e){
      if(e.target === this){
        this.style.display = "none";
      }
    };

    document.getElementById("configModalClose").onclick = function(){
      document.getElementById("configModal").style.display = "none";
    };

    document.getElementById("configModal").onclick = function(e){
      if(e.target === this){
        this.style.display = "none";
      }
    };


    // Initialize the app when DOM is ready
    document.addEventListener('DOMContentLoaded', function() {
      openDB().then(refreshRecordList).catch(console.error);
    });
  </script>


  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

</body>
</html>
